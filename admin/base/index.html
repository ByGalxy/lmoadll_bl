<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台管理 - Lmoadll</title>
    <link rel="stylesheet" href="/asses/css/style.css">
</head>
<body>
    <!-- 侧边栏 -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="/admin" class="sidebar-logo">
                Lmoadll
            </a>
        </div>
        
        <div class="sidebar-menu">
            <div class="menu-title">主菜单</div>
            <div class="menu-item">
                <a href="/admin" class="menu-link active">
                    仪表盘
                </a>
            </div>
            <div class="menu-item">
                <a href="#" class="menu-link">
                    设置
                </a>
            </div>
            <div class="menu-item">
                <a href="#" class="menu-link">
                    测试2
                </a>
            </div>
            <div class="menu-item">
                <a href="#" class="menu-link">
                    测试3
                </a>
            </div>
            <div class="menu-item">
                <a href="#" class="menu-link">
                    测试4
                </a>
            </div>
            
            <div class="divider"></div>
            
            <div class="menu-title">其他</div>
            <div class="menu-item">
                <a href="#" class="menu-link">
                    测试5
                </a>
            </div>
        </div>
    </aside>
    
    <!-- 主内容区 -->
    <div class="main-content">
        <!-- 顶部导航栏 -->
        <nav class="navbar">
            <div class="navbar-left">
                <button class="toggle-sidebar" id="toggleSidebar">
                    ☰
                </button>
            </div>
            
            <div class="navbar-right">
                <div class="user-profile">
                    <div class="user-avatar">A</div>
                    <div class="user-info">
                        <div class="user-name">......</div>
                        <div class="user-identity">......</div>
                    </div>
                </div>
                
                <button id="logoutButton" class="logout-btn">
                    退出登录
                </button>
            </div>
        </nav>
        
        <!-- 页面内容 -->
        <main class="page-content">
            <div class="page-header">
                <h1 class="page-title">欢迎使用 Lmoadll 管理后台</h1>
                <p class="page-subtitle">这里是系统的控制中心，您可以管理用户、查看统计数据以及配置系统设置。</p>
            </div>
            
            <!-- 数据概览 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div>
                            <div class="stat-title">总用户数</div>
                            <div class="stat-value">......</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 侧边栏切换
            const toggleSidebarBtn = document.getElementById('toggleSidebar');
            const sidebar = document.getElementById('sidebar');
            
            toggleSidebarBtn.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });
            
            // 登出功能
            const logoutButton = document.getElementById('logoutButton');
            
            logoutButton.addEventListener('click', function() {
                if (confirm('确定要退出登录吗？')) {
                    // 显示加载状态
                    const originalText = logoutButton.textContent;
                    logoutButton.innerHTML = '<div class="spinner"></div> 退出中...';
                    logoutButton.disabled = true;
                    
                    // 调用登出API
                    fetch('/auth/logout', {
                        method: 'GET',
                        credentials: 'same-origin'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.code === 200) {
                            // 登出成功，重定向到登录页面
                            window.location.href = '/login';
                        } else {
                            alert('登出失败：' + (data.message || '未知错误'));
                            // 恢复按钮状态
                            logoutButton.textContent = originalText;
                            logoutButton.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('登出请求失败:', error);
                        alert('登出请求失败，请稍后重试');
                        // 恢复按钮状态
                        logoutButton.textContent = originalText;
                        logoutButton.disabled = false;
                    });
                }
            });
            
            // 更新服务器时间显示
            function updateServerTime() {
                const now = new Date();
                const serverTimeElement = document.getElementById('serverTime');
                if (serverTimeElement) {
                    serverTimeElement.textContent = now.toLocaleString('zh-CN');
                }
            }
            
            // 获取并更新用户数量
            function updateUserCount() {
                fetch('/admin/user_count', {
                    method: 'POST',
                    credentials: 'same-origin'
                })
                .then(response => response.text())
                .then(count => {
                    // 将数字转换为格式化的字符串（添加千位分隔符）
                    const formattedCount = parseInt(count).toLocaleString();
                    // 更新页面上的用户数显示，只选择第一个统计卡片中的总用户数
                    const userCountElement = document.querySelector('.stat-card:first-child .stat-value');
                    if (userCountElement) {
                        userCountElement.textContent = formattedCount;
                    }
                })
                .catch(error => {
                    console.error('获取用户数量失败:', error);
                });
            }
            
            // 获取并更新管理员用户名
            function updateAdminName() {
                fetch('/admin/get_admin_name', {
                    method: 'POST',
                    credentials: 'same-origin'
                })
                .then(response => response.text())
                .then(name => {
                    // 更新页面上的用户名称显示
                    const userNameElement = document.querySelector('.user-name');
                    if (userNameElement) {
                        userNameElement.textContent = name !== 'Unknown' ? name : '管理员';
                    }
                })
                .catch(error => {
                    console.error('获取管理员名称失败:', error);
                });
            }

            // 获取并更新管理员身份
            function updateAdminIdentity() {
                fetch('/admin/get_admin_identity', {
                    method: 'POST',
                    credentials: 'same-origin'
                })
                .then(response => response.text())
                .then(identity => {
                    // 更新页面上的用户身份显示
                    const userIdentityElement = document.querySelector('.user-identity');
                    if (userIdentityElement) {
                        userIdentityElement.textContent = identity !== 'Unknown' ? identity : '管理员';
                    }
                })
                .catch(error => {
                    console.error('获取管理员身份失败:', error);
                });
            }
            
            updateServerTime();
            setInterval(updateServerTime, 1000);
            
            // 页面加载后获取用户数量、管理员名称和管理员身份
            updateUserCount();
            updateAdminName();
            updateAdminIdentity();
            
            // 处理响应式布局
            function handleResize() {
                if (window.innerWidth > 1024) {
                    sidebar.classList.add('active');
                } else {
                    sidebar.classList.remove('active');
                }
            }
            
            window.addEventListener('resize', handleResize);
            handleResize(); // 初始调用
        });
    </script>
</body>
</html>